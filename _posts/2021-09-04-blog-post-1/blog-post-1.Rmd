---
title: "Using Ecuador to Show My Mum the Effectiveness Of Vaccines"
description: |
  Watch me comb through data full of missing and nonsensical values to try and show my mother that lockdowns and vaccines are not pointless. Probably.
author:
  - name: Harriet Mason
date: 09-04-2021
output:
  distill::distill_article:
    self_contained: false
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#libraries
library(tidyverse)
library(lubridate)
library(xkcd)
#devtools::install_github("RamiKrispin/coronavirus")
library(coronavirus)
#devtools::install_github("joachim-gassen/tidycovid19")
library(tidycovid19)
```

# Introdction
I know I've reached a low point in my life when I'm listening to a Lowfi playlist that exclusively samples Bojack Horseman quotes. If that doesnt say I'm dead inside but I have work to do I'm not sure what does. My mum has been really anti-vax with all the covid stuff, she says she doesn't trust the vaccines. I have had to watch 30 minutes of anti-vax videos/articles yesterday and debunk all of them. One of them was a 10 minute rant by some random guy in a Barbados town hall meeting who was talking about how Covid-19 was a man-made bio-weapon by the Chinese government. Ecuador does not have very strong data, but even crunching their numbers (even with all the NA's) can disprove a lot of the claims in these anti-vax articles/videos but I think the easiest to look at with data is the effectiveness of vaccines. Ultimately a lot of the skepticism rhetoric centres around the view that the lockdowns are exessive and the vaccines are ineffective. The 

# Data Description
## Table 1: Lockdown Effectiveness
To assess the effectiveness of the lock downs we need a few factors. Some measure of the strictness of the lockdown, a measure of whether or not these restrictions were followed, and a measure of the

-  Google Mobility Data
The baseline day is the median value from the 5‑week period Jan 3 – Feb 6, 2020.
The same number of visitors on 2 different days of the week, result in different percentage changes
Don’t infer that larger changes mean more visitors or smaller changes mean less visitors
Avoid comparing day-to-day changes. Especially weekends with weekdays
To help you track week-to-week changes, the baseline days never change. These baseline days also don't account for seasonality. For example, visitors to parks typically increase as the weather improves.

- There is residential changes, but since this data is percentage change, and people already spent most of their time in their residence, the data is not comparable to the other categories.

## John Hopkins Data
Variables
- date
- province: province/state (it is NA for every observaiton in this dataset)
- country: country of intrest, all Ecuador
- lat: latitude of centre of geographic region (all the same)
- long: latitude of centre of geographic region (all the same)
- type: type of cases out of confirmed, death, and recovered.
- Cases: number of those types of cases

Data Issues
- about -448000 cases in august of this year (recovered)
- there are a lot of negative cases in all the categories for some reason, making a cumulative variable to see if that changes

# Effectiveness of Lockdowns
Since the point of lockdowns is to reduce the number of cases, we are going to see how the lockdown intervention measures reduced the mobility and in turn, the number of cases in Ecuador.
```{r, table1}
# cases data
cases <- coronavirus %>%
  filter(country=="Ecuador") %>%
  filter(type=="confirmed") %>%
  filter(cases>=0)%>%
  select(-c(type,province, country, lat, long))
#correct for negative case thing
cases[94,2] <- cases[94,2]-(7803+1583+1480)

# google mobility
gmobility <- download_google_cmr_data(cached=TRUE) %>%
  filter(iso3c=="ECU") %>%
  mutate(nonresidential = 
           (retail_recreation + grocery_pharmacy + parks + transit_stations + workplaces)/5) %>%
  select(c(date, residential, nonresidential)) 

# lockdown indicators stuff
NPI_oxford <- download_oxford_npi_data(type="index", cached=TRUE) %>%
  filter(iso3c=="ECU") %>%
  select(c(date, stringency_index))

# make table data
lockdown_table <- cases %>%
  full_join(gmobility, by="date") %>%
  full_join(NPI_oxford, by="date")

# keep dates with values for all variables
lockdown_table <- lockdown_table[25:590,]

#plot data
plot1data <- lockdown_table %>%
  pivot_longer(cols=cases:stringency_index, names_to = "measure", values_to = "value")

#plot restrictions and stuff
ggplot(plot1data, aes(x=date, y=value, colour=measure))+
  geom_line()+
  facet_wrap(facets=measure~., scales = "free", ncol=1) +
  theme_minimal()

#table of data
table1data <- lockdown_table %>% 
  mutate(date = format(date, format = "%Y-%m")) %>%
  group_by(date) %>%
  summarise(new_cases= sum(cases),
            residential_mobility = mean(residential),
            nonresidential_mobility = mean(nonresidential),
            stringency = mean(stringency_index)) 

#build gt table
```



```{r random, eval=FALSE}
#coronavirus package data

#make long dataset for plotting
ecuador_corona_new <- coronavirus %>%
  filter(country=="Ecuador") %>%
  select(-c(province, country, lat, long))

#plot
ggplot(ecuador_corona_new, aes(x=date, y=cases, colour=type)) + geom_line()

#make wide dataset to understand values
ecuador_corona_cum <- ecuador_corona_new %>%
  pivot_wider(names_from = type, values_from=cases) %>%
  mutate(cum_cases = cumsum(confirmed),
         cum_deaths = cumsum(death),
         cum_recovered = cumsum(recovered)) %>%
  select(-c(confirmed, death, recovered)) %>%
  mutate(deathrate = 100*cum_deaths/cum_cases)
  #pivot_longer(cols=cum_cases:cum_recovered, names_to="type", values_to = "cases")

#plot dr
ggplot(ecuador_corona_cum, aes(x=date, y=deathrate)) + geom_line()

#plot
ggplot(ecuador_corona_cum, aes(x=date, y=cases, colour=type)) + geom_line()

#cases-recovered vs death
ecuador_corona_gap <- ecuador_corona_new %>%
  pivot_wider(names_from = type, values_from=cases) %>%
  mutate(cum_cases = cumsum(confirmed),
         cum_deaths = cumsum(death),
         cum_recovered = cumsum(recovered)) %>%
  mutate(case_min_rec = cum_cases-cum_recovered) %>%
  select(-c(confirmed, death, recovered, cum_cases, cum_recovered)) %>%
  pivot_longer(cols=cum_deaths:case_min_rec, names_to="type", values_to = "cases")

#plot
ggplot(ecuador_corona_gap, aes(x=date, y=cases, colour=type)) + geom_line()
  
#tidycovid19 package data

#testing, vaccine, etc reports

#data
owid_data <- download_owid_data(silent = FALSE, cached = TRUE)%>%
  filter(iso3c=="ECU") %>%
  select(-c(iso3c, hosp_patients,icu_patients,timestamp, tests_units, positive_rate)) %>%
  pivot_longer(cols=c(total_tests,total_vaccinations), names_to = "measure", values_to = "value")

#plot
ggplot(owid_data, aes(x=date, y=value, colour=measure))+
  geom_line()

#google trends

#data
gtrend_data <- download_google_trends_data(cached=TRUE)%>%
  filter(iso3c=="ECU")

#plot
ggplot(gtrend_data, aes(x=date, y=gtrends_score)) +
  geom_line()


#lockdown and restriction details

#data 1
ACAPS_data <- download_acaps_npi_data(cached=TRUE) %>%
  filter(iso3c=="ECU")

# data 2
oxford_data <- download_oxford_npi_data(cached=TRUE) %>%
  filter(iso3c=="ECU")

# more covid case reports
# data
ECDC_cases <- download_ecdc_covid19_data(cached=TRUE) %>%
  filter(iso3c=="ECU")%>%
  filter(cases>=0)%>%
  select(c(date,cases)) %>%
  pivot_longer(cols=c(cases,deaths), names_to = "type", values_to = "number")

dr <- (32296/502146)*100

# plot these
ggplot(ECDC_cases, aes(x=date, y=number, colour=type))+
  geom_line()


# google mobility reports
gmobility <- download_google_cmr_data(cached=TRUE) %>%
  filter(iso3c=="ECU")
gmob <- gmobility%>%
  select(-c(iso3c,place_id, timestamp)) %>%
  pivot_longer(cols=retail_recreation:residential, names_to = "type", values_to = "mobilityscore")

# plot these
ggplot(gmob, aes(x=date, y=mobilityscore, colour=type))+
  #geom_smooth()+
  geom_line() +
  facet_wrap(facets=type~.)

p1 <- ggplot(gmobility, aes(x=date, colour=type))+
  geom_smooth(aes(y=mobilityscore))
p2 <- geom_line(ECDC_cases, aes(x=date))+
  geom_bar(aes(y=))+
  geom_()
```

```{r, global average}
#make wide dataset to understand values
world_corona_cum <- coronavirus %>%
  pivot_wider(id_cols=c(date, province, country), names_from = type, values_from=cases) %>%
  mutate(cum_cases = cumsum(confirmed),
         cum_deaths = cumsum(death),
         cum_recovered = cumsum(recovered)) %>%
  select(-c(confirmed, death, recovered)) %>%
  mutate(deathrate = 100*cum_deaths/cum_cases) %>%
  group_by(date, country)%>%
  summarise(deathrate = mean(deathrate)) %>%
  ungroup()

ecu <-world_corona_cum %>%
  filter(country=="Ecuador")
#plot dr
ggplot(ecu, aes(x=date, y=deathrate, colour=country)) + 
  geom_line() +
  theme(legend.position = "none")
  #geom_line(data=ecuador_corona_cum)
```


